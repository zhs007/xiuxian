# 项目开发文档：修仙卡牌

## 1. 简介

本文档是“修仙卡牌”项目的核心技术文档，旨在为开发者提供关于架构设计、核心系统、开发规范和决策记录的详细信息。与 `README.md` 的项目概述不同，本文档深入技术细节。

## 2. 核心架构设计

项目采用 **逻辑与渲染严格分离** 的架构模式。

-   **逻辑层 (`src/logic`)**: 负责处理所有游戏规则、状态管理、数据计算。这一层是纯粹的 TypeScript/JavaScript，不依赖任何渲染引擎（如 Pixi.js）。其设计目标是能够独立运行在非浏览器环境（如 Node.js 服务器或测试环境）中。
-   **渲染层 (`src/rendering`)**: 负责将逻辑层的状态可视化。它通过一个明确定义的接口从逻辑层获取数据，并使用 Pixi.js 将其渲染到画布上。渲染层不包含任何游戏逻辑。
-   **接口层 (`src/bridge`)**: 逻辑层与渲染层之间的通信桥梁。渲染层向逻辑层发送“意图”（如 `playerChoseOptionA`），逻辑层在状态更新后，通过事件或回调通知渲染层“状态已变更”（如 `gameStateUpdated`），渲染层据此更新视图。

这种分离确保了：
1.  **高可测试性**: 逻辑可以被单元测试完全覆盖，无需模拟渲染环境。
2.  **可移植性**: 未来可将逻辑层轻松迁移至后端服务器，实现客户端/服务器架构。
3.  **关注点分离**: 开发人员可以专注于逻辑或渲染的其中一部分，而不会相互干扰。

## 3. 关键系统详解

### 3.1. 属性系统
角色的属性系统设计为高度灵活的键值对结构 (`Map<string, number>`)。
-   **动态性**: 无需预先定义所有属性。卡牌和事件可以动态引入新的属性（如 `fire_resistance` 火抗, `favorability_with_npc_li` 与李姓NPC的好感度）。
-   **默认值**: 当尝试获取一个角色不存在的属性时，系统将默认返回 `0`。这简化了逻辑判断，避免了大量的 `null` 或 `undefined` 检查。

### 3.2. 事件监听系统
这是游戏中最核心的系统之一，负责处理各种因果关系。
-   **事件驱动**: 游戏中的关键动作（如属性变化、使用道具）都会作为事件被派发。
-   **事件载荷 (Payload)**: 每个事件都携带一个详细的载荷对象，例如 `AttributeChangeEvent` 会包含 `{ characterId, attributeKey, oldValue, newValue }`。
-   **跨角色监听**: 监听器可以注册监听任何角色的事件。例如，角色 A 的装备可以监听角色 B 的 `hp` 属性变化事件，从而实现“援护”或“诅咒”等效果。
-   **事件类型**:
    -   `attributeWillChange`: 属性即将变化。允许监听器否决或修改变化量。
    -   `attributeDidChange`: 属性已经变化。用于触发后续效果。
    -   `itemLost`, `itemGained`: 角色获得或失去道具。
    -   `itemWillBeUsed`, `itemUsed`: 道具使用前后的钩子。
    -   `itemEquipped`, `itemUnequipped`: 装备穿戴/卸下事件。

### 3.3. 卡池管理 (DeckManager)
卡池管理器不仅管理主事件卡池，还需支持副本机制。
-   **堆栈式结构**: `DeckManager` 内部维护一个卡池堆栈 (`Deck[]`)。正常游戏时，使用栈顶的卡池。当进入副本时，一个新的副本事件卡池被创建并压入栈顶。当副本结束时，该卡池从栈顶弹出，游戏流程回归到上一个卡池。这天然支持多层嵌套的副本。

### 3.4. 存档机制
-   **JSON 格式**: 整个游戏状态 (`GameState`) 将被序列化为一个大的 JSON 对象。这包括所有角色、他们的属性和手牌，以及 `DeckManager` 的状态。
-   **步骤记录 (Event Sourcing)**: 为了实现详细的统计分析和回放，除了完整的状态快照，系统还会记录玩家做出的每一个选择（即对事件卡的选择）。这形成一个操作日志。读档时，可以通过快照快速恢复，也可以通过重放操作日志来精确复现游戏过程，后者对于调试和分析尤其重要。

## 4. 开发规范与流程
-   **TDD 优先**: 所有新的逻辑功能都必须先编写测试用例。
-   **目录结构**: 严格遵守 `src/{logic,rendering,types,assets}` 的划分。
-   **注释**: 所有公开的类、方法和复杂逻辑块都必须有清晰的 JSDoc 注释。

## 5. 问题与决策记录
*(本部分将在开发过程中持续更新)*

-   **问题**: 如何管理由装备和 buff 带来的临时属性变化？
-   **决策**: 引入“基础属性”和“派生属性”的概念。角色的 `AttributeSystem` 只存储“基础属性”。当需要获取一个属性值时，会通过一个计算函数，结合所有生效的装备和状态效果，动态计算出最终的“派生属性”值。这避免了频繁修改基础属性，简化了状态管理。
